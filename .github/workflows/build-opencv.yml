name: Build OpenCV Android

on:
  push:
    paths:
      - 'version.env'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release after build'
        required: false
        type: boolean
        default: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Load version
        run: |
          source version.env
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Check tag does not already exist
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ env.RELEASE_TAG }}$"; then
            echo "❌ Tag ${{ env.RELEASE_TAG }} already exists — did you forget to bump the version in version.env?"
            exit 1
          fi

  build:
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86, x86_64]

    steps:
      - uses: actions/checkout@v4

      - name: Load version
        run: |
          source version.env
          echo "OPENCV_VERSION=$OPENCV_VERSION" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 default-jdk ant

      - name: Setup Android SDK + NDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;28.0.12674087'

      - name: Build OpenCV for ${{ matrix.abi }}
        env:
          ANDROID_NDK: ${{ env.ANDROID_HOME }}/ndk/28.0.12674087
        run: |
          chmod +x scripts/build_opencv_android.sh
          scripts/build_opencv_android.sh ${{ matrix.abi }}

      - name: Upload native lib for ${{ matrix.abi }}
        uses: actions/upload-artifact@v4
        with:
          name: opencv-${{ matrix.abi }}
          path: opencv-lib/src/main/jniLibs/${{ matrix.abi }}/
          retention-days: 7

      - name: Upload Java sources (arm64-v8a only)
        if: matrix.abi == 'arm64-v8a'
        uses: actions/upload-artifact@v4
        with:
          name: opencv-java-sources
          path: opencv-lib/src/main/java/
          retention-days: 7

  commit-artifacts:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Load version
        run: |
          source version.env
          echo "OPENCV_VERSION=$OPENCV_VERSION" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Clean previous artifacts
        run: |
          rm -rf opencv-lib/src/main/jniLibs/
          rm -rf opencv-lib/src/main/java/org/
          mkdir -p opencv-lib/src/main/jniLibs
          mkdir -p opencv-lib/src/main/java

      - name: Download arm64-v8a
        uses: actions/download-artifact@v4
        with:
          name: opencv-arm64-v8a
          path: opencv-lib/src/main/jniLibs/arm64-v8a/

      - name: Download armeabi-v7a
        uses: actions/download-artifact@v4
        with:
          name: opencv-armeabi-v7a
          path: opencv-lib/src/main/jniLibs/armeabi-v7a/

      - name: Download x86
        uses: actions/download-artifact@v4
        with:
          name: opencv-x86
          path: opencv-lib/src/main/jniLibs/x86/

      - name: Download x86_64
        uses: actions/download-artifact@v4
        with:
          name: opencv-x86_64
          path: opencv-lib/src/main/jniLibs/x86_64/

      - name: Download Java sources
        uses: actions/download-artifact@v4
        with:
          name: opencv-java-sources
          path: opencv-lib/src/main/java/

      - name: Verify artifacts
        run: |
          echo "=== Native libs ==="
          find opencv-lib/src/main/jniLibs -name "*.so" -exec ls -lh {} \;
          echo ""
          echo "=== Java sources ==="
          find opencv-lib/src/main/java -name "*.java" | wc -l
          echo " Java files"
          echo ""
          echo "=== Key stitching classes ==="
          for cls in Stitcher SphericalWarper MultiBandBlender BestOf2NearestMatcher VoronoiSeamFinder; do
            find opencv-lib/src/main/java -name "${cls}.java" | grep -q . \
              && echo "  ✓ ${cls}.java" \
              || echo "  ✗ ${cls}.java MISSING"
          done

      - name: Commit built artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add opencv-lib/src/main/jniLibs/ opencv-lib/src/main/java/
          git diff --cached --quiet \
            && echo "No changes to commit" \
            || git commit -m "build: OpenCV ${{ env.OPENCV_VERSION }} native libs + Java bindings [ci skip]"
          git push

      - name: Create release tag
        run: |
          git tag "${{ env.RELEASE_TAG }}"
          git push origin "${{ env.RELEASE_TAG }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "OpenCV ${{ env.OPENCV_VERSION }} Android"
          body: |
            OpenCV ${{ env.OPENCV_VERSION }} for Android with patched Java bindings.

            **Includes:**
            - Full stitching detail pipeline (setters exposed to Java)
            - SIFT feature detection
            - imread/imwrite (JPEG, PNG, WebP, TIFF)
            - 16KB page size alignment (Android 15/16 compliant)
            - ABIs: arm64-v8a, armeabi-v7a, x86, x86_64

            **Usage via JitPack:**
            ```gradle
            implementation 'com.github.jfreyer:opencv-android-custom:${{ env.RELEASE_TAG }}'
            ```
          draft: false
          prerelease: false